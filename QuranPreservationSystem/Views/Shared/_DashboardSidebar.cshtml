@using Microsoft.AspNetCore.Identity
@using QuranPreservationSystem.Infrastructure.Identity
@using QuranPreservationSystem.Services
@inject UserManager<ApplicationUser> UserManager
@inject IPermissionService PermissionService
@{
    var controller = ViewContext.RouteData.Values["controller"]?.ToString();
    var action = ViewContext.RouteData.Values["action"]?.ToString();
    var currentUser = await UserManager.GetUserAsync(User);
    var roles = currentUser != null ? await UserManager.GetRolesAsync(currentUser) : new List<string>();
    var isAdmin = roles.Contains("Admin");
}

<aside class="dashboard-sidebar">
    <div class="sidebar-content">
        <!-- Dashboard Home -->
        <div class="sidebar-section">
            <a href="@Url.Action("Index", "Dashboard")" class="sidebar-item @(controller == "Dashboard" && action == "Index" ? "active" : "")">
                <i class="fas fa-tachometer-alt"></i>
                <span>لوحة التحكم</span>
            </a>
        </div>

        <!-- إدارة البيانات الأساسية -->
        <div class="sidebar-section">
            <div class="sidebar-title">
                <i class="fas fa-database"></i>
                <span>إدارة البيانات</span>
            </div>
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Centers", "View")))
            {
                <a href="@Url.Action("Index", "Centers")" class="sidebar-item @(controller == "Centers" ? "active" : "")">
                    <i class="fas fa-mosque"></i>
                    <span>المراكز القرآنية</span>
                </a>
            }
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Teachers", "View")))
            {
                <a href="@Url.Action("Index", "Teachers")" class="sidebar-item @(controller == "Teachers" ? "active" : "")">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>المدرسين</span>
                </a>
            }
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Students", "View")))
            {
                <a href="@Url.Action("Index", "Students")" class="sidebar-item @(controller == "Students" ? "active" : "")">
                    <i class="fas fa-user-graduate"></i>
                    <span>الطلاب</span>
                </a>
            }
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "HafizRegistry", "View")))
            {
                <a href="@Url.Action("Index", "HafizRegistry")" class="sidebar-item @(controller == "HafizRegistry" ? "active" : "")">
                    <i class="fas fa-book-quran"></i>
                    <span>ديوان الحفاظ</span>
                </a>
            }
        </div>

        <!-- القرآن الكريم -->
        <div class="sidebar-section">
            <a href="@Url.Action("Index", "Quran")" class="sidebar-item @(controller == "Quran" ? "active" : "")">
                <i class="fas fa-quran"></i>
                <span>القرآن الكريم</span>
            </a>
        </div>

        <!-- إدارة الدورات -->
        <div class="sidebar-section">
            <div class="sidebar-title">
                <i class="fas fa-book"></i>
                <span>إدارة الدورات</span>
            </div>
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Courses", "View")))
            {
                <a href="@Url.Action("Index", "Courses")" class="sidebar-item @(controller == "Courses" ? "active" : "")">
                    <i class="fas fa-book-open"></i>
                    <span>الدورات</span>
                </a>
            }
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Enrollments", "View")))
            {
                <a href="@Url.Action("Index", "Enrollments")" class="sidebar-item @(controller == "Enrollments" ? "active" : "")">
                    <i class="fas fa-user-plus"></i>
                    <span>التسجيلات</span>
                </a>
            }
            
            @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Exams", "View")))
            {
                <a href="@Url.Action("Index", "Exams")" class="sidebar-item @(controller == "Exams" ? "active" : "")">
                    <i class="fas fa-file-alt"></i>
                    <span>الاختبارات</span>
                </a>
            }
        </div>

        <!-- التقارير والإحصائيات -->
        @if (isAdmin || (currentUser != null && (await PermissionService.HasPermissionAsync(currentUser.Id, "Reports", "View") || await PermissionService.HasPermissionAsync(currentUser.Id, "ImportData", "View"))))
        {
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-chart-bar"></i>
                    <span>التقارير والإحصائيات</span>
                </div>
                
                @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "Reports", "View")))
                {
                    <a href="@Url.Action("Index", "Reports")" class="sidebar-item @(controller == "Reports" && action == "Index"  ? "active" : "")">
                        <i class="fas fa-chart-pie"></i>
                        <span>التقارير</span>
                    </a>
                    
                    <a href="@Url.Action("Statistics", "Reports")" class="sidebar-item @(controller == "Reports" && action == "Statistics" ? "active" : "")">
                        <i class="fas fa-chart-line"></i>
                        <span>الإحصائيات</span>
                    </a>
                    
                    <a href="@Url.Action("Export", "Reports")" class="sidebar-item @(controller == "Reports" && action == "Export" ? "active" : "")">
                        <i class="fas fa-file-excel"></i>
                        <span>تصدير البيانات</span>
                    </a>
                }
                
                @if (isAdmin || (currentUser != null && await PermissionService.HasPermissionAsync(currentUser.Id, "ImportData", "View")))
                {
                    <a href="@Url.Action("Index", "ImportData")" class="sidebar-item @(controller == "ImportData" ? "active" : "")">
                        <i class="fas fa-file-import"></i>
                        <span>استيراد البيانات</span>
                    </a>
                }
            </div>
        }

        <!-- إدارة النظام -->
        @if (isAdmin)
        {
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-cogs"></i>
                    <span>إدارة النظام</span>
                </div>
                
                <a href="@Url.Action("Index", "Users")" class="sidebar-item @(controller == "Users" ? "active" : "")">
                    <i class="fas fa-users-cog"></i>
                    <span>المستخدمين</span>
                </a>
                
                <a href="@Url.Action("Index", "RolePermissions")" class="sidebar-item @(controller == "RolePermissions" ? "active" : "")">
                    <i class="fas fa-shield-alt"></i>
                    <span>صلاحيات الأدوار</span>
                </a>
            <a href="@Url.Action("Index", "Profile")" class="sidebar-item @(controller == "Profile" ? "active" : "")">
                <i class="fas fa-user-circle"></i>
                <span>الملف الشخصي</span>
            </a>
                
                <a href="@Url.Action("Index", "AuditLogs")" class="sidebar-item @(controller == "AuditLogs" ? "active" : "")">
                    <i class="fas fa-history"></i>
                    <span>سجل النشاطات</span>
                </a>
            </div>
        }

       
    </div>
</aside>

